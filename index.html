<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Atividade Interativa</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .toolbar { margin-bottom: 20px; }
    .toolbar label { margin-right: 8px; }
    .prompt { margin-bottom: 20px; font-size: 18px; }
    .blank { display: inline-block; min-width: 60px; border-bottom: 2px solid #000; margin: 0 4px; padding: 2px 6px; }
    .token { padding: 6px 12px; margin: 4px; border: 1px solid #444; border-radius: 8px; background: #eee; cursor: grab; }
    .token[aria-grabbed="true"] { background: #cfc; }
    .feedback { margin-top: 15px; font-weight: bold; }
    .feedback.correct { color: green; }
    .feedback.wrong { color: red; }
    .feedback.hint { color: orange; }
    .controls button { margin-right: 8px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h1>Atividade Interativa</h1>

  <div class="toolbar">
    <label for="nomeAluno">Nome e Sobrenome:</label>
    <input type="text" id="nomeAluno" placeholder="Digite seu nome completo">

    <label for="idAluno" style="margin-left:12px;">ID:</label>
    <input type="text" id="idAluno" placeholder="Digite seu ID">
  </div>

  <div id="stats">
    <span id="score">Pontuação: 0</span> | 
    <span id="progress">Questão 1 de 4</span>
  </div>

  <div id="prompt" class="prompt"></div>
  <div id="pool"></div>
  <div class="controls">
    <button id="checkBtn">Conferir</button>
    <button id="hintBtn">Dica</button>
    <button id="resetBtn">Resetar</button>
    <button id="shuffleBtn">Embaralhar</button>
    <button id="prevBtn">Anterior</button>
    <button id="nextBtn">Próxima</button>
    <button id="sendBtn">Enviar</button>
  </div>
  <div id="feedback" class="feedback"></div>

  <script>
    const SCRIPT_URL = "SUA_URL_DO_SCRIPT_AQUI"; // <-- Troque pela URL do Apps Script

    const QUESTIONS = [
      { text: "O consumidor é influenciado por fatores ____ e ____.", answers: ["culturais","sociais"], tokens: ["culturais","sociais","econômicos","pessoais"], points: 2 },
      { text: "A motivação está ligada às ____ do indivíduo.", answers: ["necessidades"], tokens: ["necessidades","emoções","valores"], points: 1 },
      { text: "O processo de decisão de compra inclui reconhecimento do ____.", answers: ["problema"], tokens: ["problema","produto","mercado"], points: 1 },
      { text: "A percepção é o processo de selecionar, organizar e interpretar ____.", answers: ["informações"], tokens: ["informações","produtos","necessidades"], points: 1 }
    ];

    let state = { index:0, score:0, placed:{}, completed:[] };

    const qs = s=>document.querySelector(s);
    const qsa = s=>Array.from(document.querySelectorAll(s));
    const promptEl=qs('#prompt');
    const poolEl=qs('#pool');
    const feedbackEl=qs('#feedback');
    const scoreStat=qs('#score');
    const progressStat=qs('#progress');

    function shuffle(arr){ return arr.map(a=>[Math.random(),a]).sort((a,b)=>a[0]-b[0]).map(a=>a[1]); }

    function render(){
      const q=QUESTIONS[state.index];
      promptEl.innerHTML='';
      state.placed={};
      let i=0;
      q.text.split('____').forEach((chunk,j,arr)=>{
        promptEl.append(chunk);
        if(j<arr.length-1){
          const span=document.createElement('span');
          span.className='blank';
          span.dataset.id=i;
          span.dataset.answer=q.answers[i];
          span.textContent='_____';
          span.addEventListener('dragover',e=>e.preventDefault());
          span.addEventListener('drop',drop);
          promptEl.append(span);
          i++;
        }
      });
      poolEl.innerHTML='';
      shuffle(q.tokens).forEach(tok=>{
        const tk=document.createElement('button');
        tk.className='token';
        tk.draggable=true;
        tk.textContent=tok;
        tk.type='button';
        tk.setAttribute('aria-grabbed','false');
        tk.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain',tok);
          tk.setAttribute('aria-grabbed','true');
        });
        tk.addEventListener('dragend',()=>tk.setAttribute('aria-grabbed','false'));
        tk.addEventListener('click',()=>{
          const blanks=qsa('.blank');
          for(const b of blanks){
            if(!state.placed[b.dataset.id]){
              b.textContent=tok;
              state.placed[b.dataset.id]=tok;
              break;
            }
          }
        });
        poolEl.append(tk);
      });
      feedbackEl.textContent='';
      progressStat.textContent=`Questão ${state.index+1} de ${QUESTIONS.length}`;
      scoreStat.textContent=`Pontuação: ${state.score}`;
    }

    function drop(e){
      e.preventDefault();
      const word=e.dataTransfer.getData('text/plain');
      e.target.textContent=word;
      state.placed[e.target.dataset.id]=word;
    }

    qs('#checkBtn').addEventListener('click',()=>{
      const q=QUESTIONS[state.index];
      let correct=true;
      qsa('.blank',promptEl).forEach(b=>{
        const val=state.placed[b.dataset.id];
        if(val===b.dataset.answer){ b.style.color='green'; }
        else { b.style.color='red'; correct=false; }
      });
      if(correct){
        if(!state.completed.includes(state.index)){
          state.score+=q.points;
          state.completed.push(state.index);
        }
        feedbackEl.textContent='Correto!';
        feedbackEl.className='feedback correct';
      }else{
        feedbackEl.textContent='Ainda não está certo.';
        feedbackEl.className='feedback wrong';
      }
      scoreStat.textContent=`Pontuação: ${state.score}`;
    });

    qs('#hintBtn').addEventListener('click',()=>{
      const q=QUESTIONS[state.index];
      let gaveHint=false;
      qsa('.blank',promptEl).forEach((b,idx)=>{
        const val=state.placed[b.dataset.id];
        if(!val){
          const ans=b.dataset.answer;
          const dica=`${ans[0]} (${ans.length} letras)`;
          feedbackEl.textContent=`Dica: a lacuna ${idx+1} começa com "${ans[0]}" e tem ${ans.length} letras.`;
          feedbackEl.className='feedback hint';
          state.score-=0.1;
          if(state.score<0) state.score=0;
          scoreStat.textContent=`Pontuação: ${state.score}`;
          gaveHint=true;
          return;
        }
      });
      if(!gaveHint){
        feedbackEl.textContent='Nenhuma dica disponível agora.';
        feedbackEl.className='feedback hint';
      }
    });

    qs('#resetBtn').addEventListener('click',()=>{render();});
    qs('#shuffleBtn').addEventListener('click',()=>{render();});
    qs('#prevBtn').addEventListener('click',()=>{ if(state.index>0){ state.index--; render(); } });
    qs('#nextBtn').addEventListener('click',()=>{ if(state.index<QUESTIONS.length-1){ state.index++; render(); } });

    // === Enviar ao Google Script ===
    qs('#sendBtn').addEventListener('click',()=>{
      const nomeAluno = qs('#nomeAluno').value.trim();
      const idAluno = qs('#idAluno').value.trim();
      if(!nomeAluno || !idAluno){
        alert("Por favor, preencha Nome e ID antes de enviar.");
        return;
      }
      const payload = {
        nome: nomeAluno,
        id: idAluno,
        pontuacao: state.score,
        acertos: state.completed.length + " de " + QUESTIONS.length
      };
      fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify(payload),
        headers: {"Content-Type":"application/json"}
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.status==="ok"){
          alert("Respostas enviadas com sucesso!");
        }else{
          alert("Erro: " + data.message);
        }
      })
      .catch(err=>{
        alert("Falha ao enviar: " + err.message);
      });
    });

    render();
  </script>
</body>
</html>